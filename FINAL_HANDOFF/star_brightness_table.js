/**
 * star_brightness_table.js
 * Bảng Miếu / Vượng / Đắc / Bình / Hãm cho 14 Chính Tinh theo 12 cung Địa Chi.
 * Trường phái: Trung Châu (phổ biến nhất).
 *
 * Giá trị: "Miếu" | "Vượng" | "Đắc" | "Bình" | "Hãm"
 */

export const STAR_BRIGHTNESS = {
    "Tử Vi": {
        "Dần": "Miếu", "Mão": "Vượng", "Thìn": "Đắc", "Tỵ": "Vượng",
        "Ngọ": "Miếu", "Mùi": "Miếu", "Thân": "Đắc", "Dậu": "Bình",
        "Tuất": "Đắc", "Hợi": "Bình", "Tý": "Vượng", "Sửu": "Bình"
    },
    "Thiên Cơ": {
        "Dần": "Miếu", "Mão": "Miếu", "Thìn": "Đắc", "Tỵ": "Vượng",
        "Ngọ": "Đắc", "Mùi": "Vượng", "Thân": "Bình", "Dậu": "Hãm",
        "Tuất": "Bình", "Hợi": "Đắc", "Tý": "Miếu", "Sửu": "Hãm"
    },
    "Thái Dương": {
        "Dần": "Đắc", "Mão": "Miếu", "Thìn": "Vượng", "Tỵ": "Miếu",
        "Ngọ": "Miếu", "Mùi": "Đắc", "Thân": "Bình", "Dậu": "Hãm",
        "Tuất": "Hãm", "Hợi": "Hãm", "Tý": "Hãm", "Sửu": "Hãm"
    },
    "Vũ Khúc": {
        "Dần": "Đắc", "Mão": "Bình", "Thìn": "Miếu", "Tỵ": "Đắc",
        "Ngọ": "Vượng", "Mùi": "Vượng", "Thân": "Đắc", "Dậu": "Bình",
        "Tuất": "Miếu", "Hợi": "Đắc", "Tý": "Vượng", "Sửu": "Miếu"
    },
    "Thiên Đồng": {
        "Dần": "Đắc", "Mão": "Bình", "Thìn": "Bình", "Tỵ": "Hãm",
        "Ngọ": "Đắc", "Mùi": "Đắc", "Thân": "Bình", "Dậu": "Hãm",
        "Tuất": "Bình", "Hợi": "Miếu", "Tý": "Miếu", "Sửu": "Miếu"
    },
    "Liêm Trinh": {
        "Dần": "Miếu", "Mão": "Đắc", "Thìn": "Đắc", "Tỵ": "Miếu",
        "Ngọ": "Đắc", "Mùi": "Bình", "Thân": "Miếu", "Dậu": "Đắc",
        "Tuất": "Hãm", "Hợi": "Hãm", "Tý": "Bình", "Sửu": "Bình"
    },
    "Thiên Phủ": {
        "Dần": "Miếu", "Mão": "Đắc", "Thìn": "Miếu", "Tỵ": "Đắc",
        "Ngọ": "Miếu", "Mùi": "Vượng", "Thân": "Đắc", "Dậu": "Đắc",
        "Tuất": "Miếu", "Hợi": "Vượng", "Tý": "Đắc", "Sửu": "Miếu"
    },
    "Thái Âm": {
        "Dần": "Hãm", "Mão": "Hãm", "Thìn": "Hãm", "Tỵ": "Hãm",
        "Ngọ": "Hãm", "Mùi": "Đắc", "Thân": "Đắc", "Dậu": "Miếu",
        "Tuất": "Miếu", "Hợi": "Miếu", "Tý": "Miếu", "Sửu": "Vượng"
    },
    "Tham Lang": {
        "Dần": "Miếu", "Mão": "Bình", "Thìn": "Vượng", "Tỵ": "Đắc",
        "Ngọ": "Bình", "Mùi": "Đắc", "Thân": "Miếu", "Dậu": "Bình",
        "Tuất": "Vượng", "Hợi": "Đắc", "Tý": "Bình", "Sửu": "Đắc"
    },
    "Cự Môn": {
        "Dần": "Miếu", "Mão": "Vượng", "Thìn": "Đắc", "Tỵ": "Miếu",
        "Ngọ": "Đắc", "Mùi": "Bình", "Thân": "Hãm", "Dậu": "Hãm",
        "Tuất": "Đắc", "Hợi": "Đắc", "Tý": "Miếu", "Sửu": "Bình"
    },
    "Thiên Tướng": {
        "Dần": "Miếu", "Mão": "Bình", "Thìn": "Miếu", "Tỵ": "Đắc",
        "Ngọ": "Miếu", "Mùi": "Đắc", "Thân": "Bình", "Dậu": "Hãm",
        "Tuất": "Miếu", "Hợi": "Đắc", "Tý": "Đắc", "Sửu": "Bình"
    },
    "Thiên Lương": {
        "Dần": "Đắc", "Mão": "Vượng", "Thìn": "Đắc", "Tỵ": "Miếu",
        "Ngọ": "Miếu", "Mùi": "Vượng", "Thân": "Bình", "Dậu": "Hãm",
        "Tuất": "Đắc", "Hợi": "Đắc", "Tý": "Đắc", "Sửu": "Miếu"
    },
    "Thất Sát": {
        "Dần": "Miếu", "Mão": "Đắc", "Thìn": "Đắc", "Tỵ": "Miếu",
        "Ngọ": "Vượng", "Mùi": "Vượng", "Thân": "Miếu", "Dậu": "Đắc",
        "Tuất": "Đắc", "Hợi": "Bình", "Tý": "Vượng", "Sửu": "Vượng"
    },
    "Phá Quân": {
        "Dần": "Hãm", "Mão": "Hãm", "Thìn": "Đắc", "Tỵ": "Hãm",
        "Ngọ": "Miếu", "Mùi": "Vượng", "Thân": "Hãm", "Dậu": "Hãm",
        "Tuất": "Đắc", "Hợi": "Hãm", "Tý": "Miếu", "Sửu": "Vượng"
    }
};

/**
 * Get brightness for a given star at a given chi position.
 * @param {string} starName - e.g. "Tham Lang"
 * @param {string} chi - e.g. "Tuất"
 * @returns {string|null} "Miếu" | "Vượng" | "Đắc" | "Bình" | "Hãm" | null
 */
export function getStarBrightness(starName, chi) {
    return STAR_BRIGHTNESS[starName]?.[chi] || null;
}

/**
 * Ngũ Hành Nạp Âm for year Can-Chi
 * Maps year Can-Chi to its Ngũ Hành Nạp Âm (element + specific name)
 */
const NGU_HANH_NAP_AM = {
    "Giáp Tý": "Kim (Hải Trung Kim)", "Ất Sửu": "Kim (Hải Trung Kim)",
    "Bính Dần": "Hỏa (Lô Trung Hỏa)", "Đinh Mão": "Hỏa (Lô Trung Hỏa)",
    "Mậu Thìn": "Mộc (Đại Lâm Mộc)", "Kỷ Tỵ": "Mộc (Đại Lâm Mộc)",
    "Canh Ngọ": "Thổ (Lộ Bàng Thổ)", "Tân Mùi": "Thổ (Lộ Bàng Thổ)",
    "Nhâm Thân": "Kim (Kiếm Phong Kim)", "Quý Dậu": "Kim (Kiếm Phong Kim)",
    "Giáp Tuất": "Hỏa (Sơn Đầu Hỏa)", "Ất Hợi": "Hỏa (Sơn Đầu Hỏa)",
    "Bính Tý": "Thủy (Giản Hạ Thủy)", "Đinh Sửu": "Thủy (Giản Hạ Thủy)",
    "Mậu Dần": "Thổ (Thành Đầu Thổ)", "Kỷ Mão": "Thổ (Thành Đầu Thổ)",
    "Canh Thìn": "Kim (Bạch Lạp Kim)", "Tân Tỵ": "Kim (Bạch Lạp Kim)",
    "Nhâm Ngọ": "Mộc (Dương Liễu Mộc)", "Quý Mùi": "Mộc (Dương Liễu Mộc)",
    "Giáp Thân": "Thủy (Tuyền Trung Thủy)", "Ất Dậu": "Thủy (Tuyền Trung Thủy)",
    "Bính Tuất": "Thổ (Ốc Thượng Thổ)", "Đinh Hợi": "Thổ (Ốc Thượng Thổ)",
    "Mậu Tý": "Hỏa (Tích Lịch Hỏa)", "Kỷ Sửu": "Hỏa (Tích Lịch Hỏa)",
    "Canh Dần": "Mộc (Tùng Bách Mộc)", "Tân Mão": "Mộc (Tùng Bách Mộc)",
    "Nhâm Thìn": "Thủy (Trường Lưu Thủy)", "Quý Tỵ": "Thủy (Trường Lưu Thủy)",
    "Giáp Ngọ": "Kim (Sa Trung Kim)", "Ất Mùi": "Kim (Sa Trung Kim)",
    "Bính Thân": "Hỏa (Sơn Hạ Hỏa)", "Đinh Dậu": "Hỏa (Sơn Hạ Hỏa)",
    "Mậu Tuất": "Mộc (Bình Địa Mộc)", "Kỷ Hợi": "Mộc (Bình Địa Mộc)",
    "Canh Tý": "Thổ (Bích Thượng Thổ)", "Tân Sửu": "Thổ (Bích Thượng Thổ)",
    "Nhâm Dần": "Kim (Kim Bạc Kim)", "Quý Mão": "Kim (Kim Bạc Kim)",
    "Giáp Thìn": "Hỏa (Phú Đăng Hỏa)", "Ất Tỵ": "Hỏa (Phú Đăng Hỏa)",
    "Bính Ngọ": "Thủy (Thiên Hà Thủy)", "Đinh Mùi": "Thủy (Thiên Hà Thủy)",
    "Mậu Thân": "Thổ (Đại Dịch Thổ)", "Kỷ Dậu": "Thổ (Đại Dịch Thổ)",
    "Canh Tuất": "Kim (Thoa Xuyến Kim)", "Tân Hợi": "Kim (Thoa Xuyến Kim)",
    "Nhâm Tý": "Mộc (Tang Đố Mộc)", "Quý Sửu": "Mộc (Tang Đố Mộc)",
    "Giáp Dần": "Thủy (Đại Khê Thủy)", "Ất Mão": "Thủy (Đại Khê Thủy)",
    "Bính Thìn": "Thổ (Sa Trung Thổ)", "Đinh Tỵ": "Thổ (Sa Trung Thổ)",
    "Mậu Ngọ": "Hỏa (Thiên Thượng Hỏa)", "Kỷ Mùi": "Hỏa (Thiên Thượng Hỏa)",
    "Canh Thân": "Mộc (Thạch Lựu Mộc)", "Tân Dậu": "Mộc (Thạch Lựu Mộc)",
    "Nhâm Tuất": "Thủy (Đại Hải Thủy)", "Quý Hợi": "Thủy (Đại Hải Thủy)"
};

/**
 * Get Ngũ Hành Nạp Âm from year Can-Chi
 * @param {string} yearStem - e.g. "Kỷ"
 * @param {string} yearBranch - e.g. "Tỵ"
 * @returns {{ element: string, fullName: string } | null}
 */
export function getNguHanhNapAm(yearStem, yearBranch) {
    const key = `${yearStem} ${yearBranch}`;
    const val = NGU_HANH_NAP_AM[key];
    if (!val) return null;
    const match = val.match(/^(\S+)\s*\((.+)\)$/);
    if (match) return { element: match[1], fullName: match[2] };
    return { element: val, fullName: val };
}

/**
 * Cục Ngũ Hành mapping
 */
const CUC_ELEMENT = {
    2: "Thủy", 3: "Mộc", 4: "Kim", 5: "Thổ", 6: "Hỏa"
};

/**
 * Ngũ Hành tương sinh/khắc
 */
const NGU_HANH_RELATIONS = {
    "Mộc": { sinh: "Hỏa", khắc: "Thổ", bịKhắc: "Kim", bịSinh: "Thủy" },
    "Hỏa": { sinh: "Thổ", khắc: "Kim", bịKhắc: "Thủy", bịSinh: "Mộc" },
    "Thổ": { sinh: "Kim", khắc: "Thủy", bịKhắc: "Mộc", bịSinh: "Hỏa" },
    "Kim": { sinh: "Thủy", khắc: "Mộc", bịKhắc: "Hỏa", bịSinh: "Thổ" },
    "Thủy": { sinh: "Mộc", khắc: "Hỏa", bịKhắc: "Thổ", bịSinh: "Kim" }
};

/**
 * Analyze Mệnh-Cục relationship
 * @param {string} yearStem - e.g. "Kỷ"
 * @param {string} yearBranch - e.g. "Tỵ"
 * @param {number} cucNum - e.g. 6
 * @returns {{ menhElement, menhFullName, cucElement, relationship, explanation }}
 */
export function analyzeMenhCuc(yearStem, yearBranch, cucNum) {
    const napAm = getNguHanhNapAm(yearStem, yearBranch);
    if (!napAm) return null;

    const cucElement = CUC_ELEMENT[cucNum];
    if (!cucElement) return null;

    const menhEl = napAm.element;
    const rel = NGU_HANH_RELATIONS[menhEl];
    let relationship, explanation;

    if (rel.sinh === cucElement) {
        relationship = "Mệnh SINH Cục";
        explanation = "Hao tổn tâm lực, phải nỗ lực nhiều mới thành. Là người vì người khác, cho đi nhiều hơn nhận.";
    } else if (rel.bịSinh === cucElement) {
        relationship = "Cục SINH Mệnh";
        explanation = "Được trợ lực từ hoàn cảnh, môi trường giúp đỡ. Vận may đến tự nhiên, cuộc sống thuận lợi.";
    } else if (rel.khắc === cucElement) {
        relationship = "Mệnh KHẮC Cục";
        explanation = "Làm chủ được hoàn cảnh, có ý chí mạnh mẽ kiểm soát vận mệnh, nhưng phải chủ động.";
    } else if (rel.bịKhắc === cucElement) {
        relationship = "Cục KHẮC Mệnh";
        explanation = "Gặp nhiều cản trở từ hoàn cảnh, đường đời gập ghềnh. Cần ý chí sắt đá để vượt qua.";
    } else if (menhEl === cucElement) {
        relationship = "Mệnh Cục TƯƠNG HÒA";
        explanation = "Hài hòa, cân bằng, cuộc sống ổn định nhưng ít đột phá lớn.";
    } else {
        relationship = "Không xác định";
        explanation = "";
    }

    return {
        menhElement: menhEl,
        menhFullName: napAm.fullName,
        cucElement,
        relationship,
        explanation
    };
}

/**
 * Âm Dương analysis
 * Check if gender + year stem + palace chi creates harmony or conflict
 */
const CAN_AM_DUONG = {
    "Giáp": "Dương", "Bính": "Dương", "Mậu": "Dương", "Canh": "Dương", "Nhâm": "Dương",
    "Ất": "Âm", "Đinh": "Âm", "Kỷ": "Âm", "Tân": "Âm", "Quý": "Âm"
};
const CHI_AM_DUONG = {
    "Tý": "Dương", "Dần": "Dương", "Thìn": "Dương", "Ngọ": "Dương", "Thân": "Dương", "Tuất": "Dương",
    "Sửu": "Âm", "Mão": "Âm", "Tỵ": "Âm", "Mùi": "Âm", "Dậu": "Âm", "Hợi": "Âm"
};

/**
 * @param {string} gender - "Nam" | "Nu"
 * @param {string} yearStem - e.g. "Kỷ"
 * @param {string} menhChi - e.g. "Tuất"
 * @returns {{ genderYin, yearYin, palaceYin, isHarmony, explanation }}
 */
export function analyzeAmDuong(gender, yearStem, menhChi) {
    const genderYD = gender === "Nam" ? "Dương" : "Âm";
    const yearYD = CAN_AM_DUONG[yearStem] || "Dương";
    const palaceYD = CHI_AM_DUONG[menhChi] || "Dương";

    // Thuận: Nam Dương, Nữ Âm. Xem can năm + cung mệnh
    const yearGenderMatch = (gender === "Nam" && yearYD === "Dương") || (gender !== "Nam" && yearYD === "Âm");
    const palaceMatch = yearYD === palaceYD;

    let explanation;
    if (yearGenderMatch && palaceMatch) {
        explanation = "Thuận lý: Giới tính, Can năm, Cung Mệnh đều thuận Âm Dương. Đường đời ít trắc trở, thuận buồm xuôi gió.";
    } else if (!yearGenderMatch && !palaceMatch) {
        explanation = "Nghịch lý kép: Giới tính nghịch Can năm, Cung Mệnh nghịch Can năm. Đường đời nhiều thử thách, thành công thường đến sau gian nan.";
    } else if (!yearGenderMatch) {
        explanation = `Nghịch lý nhẹ: ${gender} mang mệnh ${yearYD === "Dương" ? "Dương" : "Âm"} Can. Khổ trước sướng sau, phải tự lực cánh sinh.`;
    } else {
        explanation = `Nghịch cung: Mệnh ${yearYD} đóng cung ${palaceYD}. Tài năng dễ bị kìm hãm giai đoạn đầu, càng về sau càng phát.`;
    }

    return {
        genderYin: genderYD,
        yearYin: yearYD,
        palaceYin: palaceYD,
        isHarmony: yearGenderMatch && palaceMatch,
        explanation
    };
}

/**
 * Tứ Hóa Lưu Niên - For a given year stem, which stars get which Hóa
 */
const TU_HOA_LUU_NIEN = {
    "Giáp": { "Hóa Lộc": "Liêm Trinh", "Hóa Quyền": "Phá Quân", "Hóa Khoa": "Vũ Khúc", "Hóa Kỵ": "Thái Dương" },
    "Ất": { "Hóa Lộc": "Thiên Cơ", "Hóa Quyền": "Thiên Lương", "Hóa Khoa": "Tử Vi", "Hóa Kỵ": "Thái Âm" },
    "Bính": { "Hóa Lộc": "Thiên Đồng", "Hóa Quyền": "Thiên Cơ", "Hóa Khoa": "Văn Xương", "Hóa Kỵ": "Liêm Trinh" },
    "Đinh": { "Hóa Lộc": "Thái Âm", "Hóa Quyền": "Thiên Đồng", "Hóa Khoa": "Thiên Cơ", "Hóa Kỵ": "Cự Môn" },
    "Mậu": { "Hóa Lộc": "Tham Lang", "Hóa Quyền": "Thái Âm", "Hóa Khoa": "Hữu Bật", "Hóa Kỵ": "Thiên Cơ" },
    "Kỷ": { "Hóa Lộc": "Vũ Khúc", "Hóa Quyền": "Tham Lang", "Hóa Khoa": "Thiên Lương", "Hóa Kỵ": "Văn Khúc" },
    "Canh": { "Hóa Lộc": "Thái Dương", "Hóa Quyền": "Vũ Khúc", "Hóa Khoa": "Thái Âm", "Hóa Kỵ": "Thiên Đồng" },
    "Tân": { "Hóa Lộc": "Cự Môn", "Hóa Quyền": "Thái Dương", "Hóa Khoa": "Văn Khúc", "Hóa Kỵ": "Văn Xương" },
    "Nhâm": { "Hóa Lộc": "Thiên Lương", "Hóa Quyền": "Tử Vi", "Hóa Khoa": "Tả Phù", "Hóa Kỵ": "Vũ Khúc" },
    "Quý": { "Hóa Lộc": "Phá Quân", "Hóa Quyền": "Cự Môn", "Hóa Khoa": "Thái Âm", "Hóa Kỵ": "Tham Lang" }
};

/**
 * Get Tứ Hóa for a given year stem (lưu niên)
 * @param {string} yearStem - e.g. "Bính"
 * @returns {{ "Hóa Lộc": string, "Hóa Quyền": string, "Hóa Khoa": string, "Hóa Kỵ": string } | null}
 */
export function getTuHoaLuuNien(yearStem) {
    return TU_HOA_LUU_NIEN[yearStem] || null;
}
