name: Deploy ThÃ¡i áº¤t

on:
  push:
    branches:
      - master

jobs:
  # â”€â”€ Step 1: Build & Verify â”€â”€
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # Backend build test
      - name: Backend - Install dependencies
        working-directory: TUVI-BE
        run: npm ci

      - name: Backend - Build
        working-directory: TUVI-BE
        run: npm run build

      # CMS build test
      - name: CMS - Install dependencies
        working-directory: TUVI_CMS_FE
        run: npm ci

      - name: CMS - Build
        working-directory: TUVI_CMS_FE
        run: npx vite build

  # â”€â”€ Step 2: Deploy to VPS â”€â”€
  deploy:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Upload code to VPS via SCP
      - name: Deploy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          source: "TUVI-BE/,TUVI_CMS_FE/,FINAL_HANDOFF/,deploy.sh,.github/"
          target: /root/app
          overwrite: true
          strip_components: 0

      # Build & restart Docker on VPS
      - name: Docker Build & Health Check
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          command_timeout: 10m
          script: |
            cd /root/app/TUVI-BE
            docker compose -f docker/docker-compose.yml up -d --build app cms

            # Copy prediction tool files into BE container
            CONTAINER_ID=$(docker ps -q -f name=be-app | head -1)
            if [ -n "$CONTAINER_ID" ]; then
              docker cp /root/app/FINAL_HANDOFF/server_engine.js $CONTAINER_ID:/home/tools/bin/server_engine.js
              docker cp /root/app/FINAL_HANDOFF/prompt_builder_v1.js $CONTAINER_ID:/home/tools/bin/prompt_builder_v1.js
              echo "âœ… Prediction tool files copied"
            fi

            # Restart nginx to re-resolve Docker DNS (prevents 502)
            docker restart nginx
            echo "âœ… Nginx restarted"

            # Wait for startup
            sleep 15

            # Health check (3 attempts, 10s apart)
            HEALTHY=false
            for i in 1 2 3; do
              if curl -sf http://localhost:3000/auth/health > /dev/null 2>&1; then
                echo "âœ… Backend healthy (attempt $i)"
                HEALTHY=true
                break
              fi
              echo "â³ Attempt $i/3..."
              sleep 10
            done

            if [ "$HEALTHY" = false ]; then
              echo "âŒ Health check failed"
              exit 1
            fi

            # Restart investment microservice AFTER BE is healthy
            # (microservice loads CSV from BE at startup)
            pm2 restart investment_tool --silent 2>/dev/null || true
            sleep 3
            echo "âœ… Investment microservice restarted"

      - name: Telegram - Success âœ…
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            âœ… *Deploy ThÃ¡i áº¤t thÃ nh cÃ´ng*
            ğŸ“¦ Commit: `${{ github.sha }}`
            ğŸ‘¤ By: ${{ github.actor }}
            ğŸ“ ${{ github.event.head_commit.message }}

      - name: Telegram - Failed âŒ
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            âŒ *Deploy ThÃ¡i áº¤t tháº¥t báº¡i!*
            ğŸ“¦ Commit: `${{ github.sha }}`
            ğŸ‘¤ By: ${{ github.actor }}
            ğŸ”— [Xem logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
